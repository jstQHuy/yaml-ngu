# Signature Knowledge Base (starter)
# Purpose: Recon + VA (Level 1). Maps evidence -> likely vuln types / CVE hints.
#
# Supported "when" keys (kb_query.py supports these):
# - service_any: ["http","ssh",...]
# - port_any: ["80","8080",...]
# - product_regex: ["(?i)apache", ...]
# - version_regex: ["\\b2\\.4\\.49\\b", ...]
# - banner_regex: ["OpenSSH[_/ ]7\\.2p2", ...]
# - http_title_regex: ["(?i)jenkins", ...]  (matched against evidence lines)
# - any_path_regex: ["^/cgi-bin/.*\\.sh$", ...]
# - any_header_regex: ["(?i)^Server:\\s*Apache/2\\.4\\.49", ...] (matched against evidence lines)
# - any_body_regex: ["(?i)wp-content", ...] (matched against evidence lines)

- id: SIG_SHELLSHOCK_CGI_SH
  title: "Potential Shellshock surface via CGI .sh"
  when:
    service_any: ["http", "http-proxy"]
    any_path_regex:
      - "^/cgi-bin/.*\\.sh$"
      - "^/cgi-bin/user\\.sh$"
      - "^/cgi-bin/status$"
      - "^/cgi-bin/test$"
  then:
    vuln_type: "RCE (Shellshock surface)"
    cve_hints: ["CVE-2014-6271", "CVE-2014-7169"]
    confidence: 0.85
    evidence_template:
      - "CGI endpoint suggests bash/CGI surface: {matched_path}"

- id: SIG_CGI_BIN_PRESENT
  title: "CGI directory exposed"
  when:
    service_any: ["http", "http-proxy"]
    any_path_regex: ["^/cgi-bin/?$"]
  then:
    vuln_type: "Exposure (CGI enabled)"
    cve_hints: []
    confidence: 0.55
    evidence_template:
      - "CGI directory appears present: {matched_path}"

- id: SIG_APACHE_2_4_49
  title: "Apache HTTP Server 2.4.49 detected (path traversal/RCE history)"
  when:
    service_any: ["http", "http-proxy"]
    product_regex: ["(?i)apache"]
    version_regex: ["\\b2\\.4\\.49\\b"]
  then:
    vuln_type: "Known-CVE surface (Apache httpd 2.4.49)"
    cve_hints: ["CVE-2021-41773", "CVE-2021-42013"]
    confidence: 0.75
    evidence_template:
      - "Apache version evidence indicates 2.4.49: {matched_version}"

- id: SIG_APACHE_2_4_50_TO_2_4_51
  title: "Apache HTTP Server 2.4.50–2.4.51 detected (path traversal/RCE history)"
  when:
    service_any: ["http", "http-proxy"]
    product_regex: ["(?i)apache"]
    version_regex: ["\\b2\\.4\\.(50|51)\\b"]
  then:
    vuln_type: "Known-CVE surface (Apache httpd 2.4.50–2.4.51)"
    cve_hints: ["CVE-2021-41773", "CVE-2021-42013"]
    confidence: 0.70
    evidence_template:
      - "Apache version evidence indicates 2.4.50–2.4.51: {matched_version}"

- id: SIG_TOMCAT_MANAGER
  title: "Apache Tomcat Manager interface likely present"
  when:
    service_any: ["http", "http-proxy"]
    any_path_regex:
      - "^/manager/html/?$"
      - "^/host-manager/html/?$"
  then:
    vuln_type: "Exposure (Tomcat administrative surface)"
    cve_hints: []
    confidence: 0.70
    evidence_template:
      - "Admin interface path found: {matched_path}"

- id: SIG_JENKINS_UI
  title: "Jenkins UI likely present"
  when:
    service_any: ["http", "http-proxy"]
    http_title_regex: ["(?i)jenkins"]
  then:
    vuln_type: "Exposure (CI surface: Jenkins)"
    cve_hints: []
    confidence: 0.65
    evidence_template:
      - "HTTP title indicates Jenkins: {matched_title}"

- id: SIG_GITLAB_UI
  title: "GitLab UI likely present"
  when:
    service_any: ["http", "http-proxy"]
    http_title_regex: ["(?i)gitlab"]
  then:
    vuln_type: "Exposure (DevOps surface: GitLab)"
    cve_hints: []
    confidence: 0.60
    evidence_template:
      - "HTTP title indicates GitLab: {matched_title}"

- id: SIG_WORDPRESS_CORE
  title: "WordPress likely present (common paths)"
  when:
    service_any: ["http", "http-proxy"]
    any_path_regex:
      - "^/wp-login\\.php$"
      - "^/wp-admin/?$"
      - "^/wp-content/.*"
      - "^/wp-includes/.*"
      - "^/wp-json/?"
  then:
    vuln_type: "Exposure (CMS: WordPress)"
    cve_hints: []
    confidence: 0.70
    evidence_template:
      - "WordPress path observed: {matched_path}"

- id: SIG_WP_REST_4_7_X_HYPOTHESIS
  title: "WP REST exposed; if version 4.7.0/4.7.1 then CVE-2017-1001000 may apply"
  when:
    service_any: ["http", "http-proxy"]
    any_path_regex: ["^/wp-json/?$"]
  then:
    vuln_type: "Known-CVE hypothesis (requires WP version confirmation)"
    cve_hints: ["CVE-2017-1001000"]
    confidence: 0.45
    evidence_template:
      - "WP REST endpoint present; confirm WP core version before asserting CVE."

- id: SIG_DRUPAL
  title: "Drupal likely present (common paths)"
  when:
    service_any: ["http", "http-proxy"]
    any_path_regex:
      - "^/user/login$"
      - "^/sites/default/.*"
      - "^/core/.*"
  then:
    vuln_type: "Exposure (CMS: Drupal)"
    cve_hints: []
    confidence: 0.55
    evidence_template:
      - "Drupal-like path observed: {matched_path}"

- id: SIG_STRUTS2_SURFACE
  title: "Apache Struts2 surface indicators"
  when:
    service_any: ["http", "http-proxy"]
    any_path_regex:
      - "^/struts2-showcase/.*"
      - "^/struts/.*"
      - "^/webapp/struts/.*"
  then:
    vuln_type: "Known-CVE surface (Struts2 family; validate exact component/version)"
    cve_hints: ["CVE-2017-5638"]
    confidence: 0.55
    evidence_template:
      - "Struts-related path observed: {matched_path}"

- id: SIG_PHP_CGI_HANDLER_HYPOTHESIS
  title: "PHP-CGI handler surface hypothesis"
  when:
    service_any: ["http", "http-proxy"]
    any_path_regex:
      - "^/cgi-bin/php\\b.*"
      - "^/php-cgi\\b.*"
  then:
    vuln_type: "Known-CVE surface (PHP-CGI handler)"
    cve_hints: ["CVE-2012-1823"]
    confidence: 0.55
    evidence_template:
      - "PHP-CGI-like handler path observed: {matched_path}"

- id: SIG_PHPINFO
  title: "phpinfo page exposure"
  when:
    service_any: ["http", "http-proxy"]
    any_path_regex:
      - "^/phpinfo\\.php$"
      - "^/info\\.php$"
  then:
    vuln_type: "Information Disclosure (phpinfo exposure)"
    cve_hints: []
    confidence: 0.75
    evidence_template:
      - "Sensitive info endpoint suspected: {matched_path}"

- id: SIG_DIR_LISTING_INDEXOF
  title: "Directory listing likely enabled"
  when:
    service_any: ["http", "http-proxy"]
    any_body_regex:
      - "(?i)<title>\\s*Index of /"
      - "(?i)Index of /"
  then:
    vuln_type: "Misconfiguration (Directory Listing)"
    cve_hints: []
    confidence: 0.70
    evidence_template:
      - "Directory listing marker observed in response body."

- id: SIG_GIT_EXPOSED
  title: ".git directory exposure indicators"
  when:
    service_any: ["http", "http-proxy"]
    any_path_regex:
      - "^/\\.git/HEAD$"
      - "^/\\.git/config$"
      - "^/\\.git/index$"
  then:
    vuln_type: "Information Disclosure (Exposed VCS metadata)"
    cve_hints: []
    confidence: 0.80
    evidence_template:
      - "Exposed git metadata path: {matched_path}"

- id: SIG_ENV_EXPOSED
  title: ".env file exposure indicators"
  when:
    service_any: ["http", "http-proxy"]
    any_path_regex: ["^/\\.env$"]
  then:
    vuln_type: "Information Disclosure (Exposed environment file)"
    cve_hints: []
    confidence: 0.80
    evidence_template:
      - "Exposed environment file path: {matched_path}"

- id: SIG_ADMIN_LOGIN_SURFACE
  title: "Generic admin/login surface"
  when:
    service_any: ["http", "http-proxy"]
    any_path_regex:
      - "^/admin/?$"
      - "^/administrator/?$"
      - "^/login/?$"
      - "^/signin/?$"
      - "^/wp-login\\.php$"
  then:
    vuln_type: "Exposure (Authentication surface)"
    cve_hints: []
    confidence: 0.50
    evidence_template:
      - "Auth/admin entry point observed: {matched_path}"

- id: SIG_SWAGGER_UI
  title: "Swagger/OpenAPI UI exposed"
  when:
    service_any: ["http", "http-proxy"]
    any_path_regex:
      - "^/swagger/?$"
      - "^/swagger-ui/?$"
      - "^/api-docs/?$"
      - "^/v2/api-docs$"
      - "^/openapi\\.json$"
  then:
    vuln_type: "Exposure (API documentation surface)"
    cve_hints: []
    confidence: 0.65
    evidence_template:
      - "API documentation endpoint: {matched_path}"

- id: SIG_APACHE_SERVER_STATUS
  title: "Apache server-status endpoint exposed"
  when:
    service_any: ["http", "http-proxy"]
    any_path_regex: ["^/server-status/?$"]
  then:
    vuln_type: "Information Disclosure (Server Status exposure)"
    cve_hints: []
    confidence: 0.65
    evidence_template:
      - "server-status endpoint observed: {matched_path}"

- id: SIG_SMB_SAMBA_3_0_20
  title: "Samba 3.0.20 detected (username map script RCE history)"
  when:
    service_any: ["smb","netbios-ssn","microsoft-ds"]
    product_regex: ["(?i)samba"]
    version_regex: ["\\b3\\.0\\.20\\b"]
  then:
    vuln_type: "Known-CVE surface (Samba 3.0.20)"
    cve_hints: ["CVE-2007-2447"]
    confidence: 0.80
    evidence_template:
      - "Samba version evidence indicates 3.0.20: {matched_version}"

- id: SIG_VSFTPD_2_3_4
  title: "vsftpd 2.3.4 banner detected (historic backdoor)"
  when:
    service_any: ["ftp"]
    banner_regex: ["(?i)vsftpd\\s*2\\.3\\.4"]
  then:
    vuln_type: "Known-CVE surface (vsftpd 2.3.4)"
    cve_hints: ["CVE-2011-2523"]
    confidence: 0.85
    evidence_template:
      - "FTP banner indicates vsftpd 2.3.4: {matched_banner}"

- id: SIG_PROFTPD_1_3_5
  title: "ProFTPD 1.3.5 detected (mod_copy CVE history)"
  when:
    service_any: ["ftp"]
    banner_regex: ["(?i)proftpd\\s*1\\.3\\.5"]
  then:
    vuln_type: "Known-CVE surface (ProFTPD 1.3.5)"
    cve_hints: ["CVE-2015-3306"]
    confidence: 0.70
    evidence_template:
      - "FTP banner indicates ProFTPD 1.3.5: {matched_banner}"

- id: SIG_OPENSSH_7_9P1
  title: "OpenSSH 7.9p1 detected (triage candidate set)"
  when:
    service_any: ["ssh"]
    banner_regex: ["(?i)openssh[_/ ]7\\.9p1"]
  then:
    vuln_type: "Version-based triage (OpenSSH)"
    cve_hints: []
    confidence: 0.40
    evidence_template:
      - "SSH banner indicates OpenSSH 7.9p1: {matched_banner}"

- id: SIG_GOLANG_PPROF
  title: "Golang pprof debug endpoints exposed"
  when:
    service_any: ["http","http-proxy"]
    any_path_regex:
      - "^/debug/pprof/?$"
      - "^/debug/pprof/.*"
  then:
    vuln_type: "Information Disclosure (Debug endpoint exposure)"
    cve_hints: []
    confidence: 0.70
    evidence_template:
      - "Debug endpoint observed: {matched_path}"

- id: SIG_SPRING_ACTUATOR
  title: "Spring Boot actuator endpoints exposed"
  when:
    service_any: ["http","http-proxy"]
    any_path_regex:
      - "^/actuator/?$"
      - "^/actuator/env$"
      - "^/actuator/heapdump$"
      - "^/actuator/metrics$"
  then:
    vuln_type: "Information Disclosure / Misconfiguration (Actuator exposure)"
    cve_hints: []
    confidence: 0.65
    evidence_template:
      - "Actuator endpoint observed: {matched_path}"

- id: SIG_WEBDAV
  title: "WebDAV surface indicators (headers)"
  when:
    service_any: ["http","http-proxy"]
    any_header_regex:
      - "(?i)^DAV:\\s*"
      - "(?i)^Allow:.*\\b(PROPFIND|PROPPATCH|MKCOL|COPY|MOVE|LOCK|UNLOCK)\\b"
  then:
    vuln_type: "Exposure (WebDAV enabled)"
    cve_hints: []
    confidence: 0.55
    evidence_template:
      - "WebDAV-related header observed."

- id: SIG_HTTP_TRACE_ENABLED
  title: "HTTP TRACE method potentially enabled (Allow header)"
  when:
    service_any: ["http","http-proxy"]
    any_header_regex: ["(?i)^Allow:.*\\bTRACE\\b"]
  then:
    vuln_type: "Misconfiguration (TRACE enabled)"
    cve_hints: []
    confidence: 0.45
    evidence_template:
      - "Allow header contains TRACE."

- id: SIG_CORS_WILDCARD
  title: "CORS wildcard (ACAO: *) observed"
  when:
    service_any: ["http","http-proxy"]
    any_header_regex: ["(?i)^Access-Control-Allow-Origin:\\s*\\*$"]
  then:
    vuln_type: "Misconfiguration (CORS wildcard)"
    cve_hints: []
    confidence: 0.55
    evidence_template:
      - "Access-Control-Allow-Origin: * observed."
# Struts2 signature add-on (triage/hypothesis only)
# Rationale: ".action" endpoints and "/struts*" paths are strong indicators of Struts-style MVC apps.
# Note: These rules provide CVE *candidates*; version/config confirmation is required before any claim.

- id: SIG_STRUTS2_ACTION_ENDPOINT
  title: "Struts-style .action endpoint observed (candidate set)"
  when:
    service_any: ["http", "http-proxy"]
    any_path_regex:
      - ".*\\.action$"
  then:
    vuln_type: "Known-CVE hypothesis (Apache Struts2 surface)"
    cve_hints:
      - "CVE-2017-5638"     # S2-045 (Jakarta Multipart parser)
      - "CVE-2018-11776"    # S2-057 (namespace handling)
      - "CVE-2019-0230"     # S2-059 (OGNL evaluation)
      - "CVE-2020-17530"    # S2-061 (OGNL evaluation)
    confidence: 0.60
    evidence_template:
      - "Found .action endpoint (common in Struts apps): {matched_path}"
      - "Confirm Struts2 version/config and error signatures before asserting a specific CVE."

- id: SIG_STRUTS2_STRUTS_PATH
  title: "Struts/Struts2 path observed (candidate set)"
  when:
    service_any: ["http", "http-proxy"]
    any_path_regex:
      - "^/struts/.*"
      - "^/struts2/.*"
      - "^/struts2-showcase/.*"
  then:
    vuln_type: "Known-CVE hypothesis (Apache Struts2 surface)"
    cve_hints:
      - "CVE-2017-5638"
      - "CVE-2018-11776"
      - "CVE-2019-0230"
      - "CVE-2020-17530"
    confidence: 0.70
    evidence_template:
      - "Struts-related path observed: {matched_path}"
      - "Validate Struts2 component/version before selecting a CVE."

- id: SIG_STRUTS2_MONITORING_WELCOME_ACTION
  title: "Monitoring + Welcome.action pattern (Stratosphere-style surface)"
  when:
    service_any: ["http", "http-proxy"]
    any_path_regex:
      - "^/Monitoring/.*/Welcome\\.action$"
  then:
    vuln_type: "Known-CVE hypothesis (Struts2 action endpoint)"
    cve_hints:
      - "CVE-2017-5638"
      - "CVE-2018-11776"
    confidence: 0.75
    evidence_template:
      - "Observed Struts-style endpoint under Monitoring: {matched_path}"
      - "Use planning to validate with safe checks (headers, error pages) before narrowing to one CVE."

